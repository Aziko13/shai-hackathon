# BI-GPT: Агент по корпоративной БД

> **Natural Language → SQL** для бизнес-аналитики

BI-GPT — это интеллектуальный агент, который позволяет руководителям задавать BI-вопросы "по-человечески" и получать корректные ответы с визуализацией данных. Система построена на базе LangGraph и интегрирована с Telegram-ботом для удобного взаимодействия.

## Цель проекта

Создать агента, который:
- Понимает естественно-языковые запросы на русском языке
- Генерирует безопасный SQL-код
- Учитывает бизнес-словарь и контекст
- Возвращает корректные агрегаты с пояснениями
- Создает визуализации данных

## Архитектура

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Telegram Bot  │───▶│  LangGraph      │───▶│   SQLite DB     │
│                 │    │  Agent          │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │
                              ▼
                       ┌─────────────────┐
                       │  Visualization  │
                       │  (Matplotlib)   │
                       └─────────────────┘
```

### Компоненты системы

1. **LangGraph Agent** (`app/agent.py`) - Основной агент с роутингом
2. **Tools** (`app/tools.py`) - Инструменты для работы с БД
3. **Telegram Bot** (`app/bot.py`) - Интерфейс пользователя
4. **Artifacts Store** (`app/artifacts.py`) - Кэширование данных
5. **Prompts** (`app/prompts.py`) - Системные промпты

## Быстрый старт

### Установка зависимостей

```bash
pip install -r requirements.txt
```

### Настройка окружения

Создайте файл `.env`:

```env
# Telegram Bot
TELEGRAM_BOT_TOKEN=your_telegram_bot_token

# LLM Model
AGENT_MODEL=openai:llama4scout

# Database
DB_PATH=retail_demo.db path

# Directories
PLOTS_DIR=data/plots
STATIC_DIR=static
```

### Запуск Telegram-бота

```bash
python -m app.bot
```

### Тестирование агента

```bash
# Запуск тестов
python -m pytest tests/

# Интерактивное тестирование
jupyter notebook test.ipynb
```

## Доступные инструменты

### База данных
- `get_current_date()` - Получить текущую дату
- `list_tables()` - Список таблиц в БД
- `describe_table(table_name)` - Схема таблицы
- `execute_query(sql)` - Выполнение SQL-запроса

### Аналитика
- `give_column_summary(handle_id, col_name)` - Статистика по колонке
- `make_simple_plot(handle, x_col, y_col, title, plot_type)` - Создание графиков

### Прогнозирование
- `get_forecast(handle, col_name, horizon)` - Прогнозирование временных рядов

## Примеры запросов

### Простые запросы
```
"Какие таблицы есть в базе данных?"
"Покажи схему таблицы fact_sales"
"Какая сегодня дата?"
```

### Аналитические запросы
```
"График топ-5 продуктов по продажам в тенге за последние 30 дней"
"Средний чек за последний месяц"
"Динамика продаж по дням"
"Маржинальность по категориям товаров"
```

### Сложные запросы
```
"Сравни продажи этого месяца с прошлым"
"Покажи сезонность по товарным категориям"
"Топ-10 клиентов по объему покупок"
```

### Прогнозирование
```
"Прогноз продаж на следующие 14 дней"
"Спрогнозируй выручку на месяц вперед"
"Покажи прогноз продаж по дням с графиком"
"Какие будут продажи в следующем месяце?"
```

## Технические детали

### Модель LLM
- **Базовая модель**: llama4scout
- **Endpoint**: https://lzl4i1wx0cdh9a-8000.proxy.runpod.net/v1
- **Формат ответов**: JSON для роутинга

### База данных
- **Тип**: SQLite3
- **Схема**: Розничная торговля (продажи, товары, клиенты)
- **Безопасность**: Только SELECT-запросы

### Визуализация
- **Библиотека**: Matplotlib
- **Форматы**: PNG
- **Типы графиков**: Bar, Line, Scatter

### Прогнозирование
- **Библиотека**: Darts (Time Series)
- **Модель**: ExponentialSmoothing
- **Горизонт**: Настраиваемый (по умолчанию 14 дней)
- **Данные**: Временные ряды с датами и числовыми значениями

## Метрики качества

### ML/AI метрики
- **Exact match accuracy** - Точность SQL-запросов
- **Execution accuracy** - Успешность выполнения запросов
- **Hallucination rate** - Частота галлюцинаций (↓)

### Бизнес-метрики
- **Self-service rate** - % вопросов без аналитика
- **Response time** - Время ответа
- **Queue reduction** - Снижение очереди в BI

### Инженерные метрики
- **PII leakage** - Отсутствие утечек персональных данных
- **Query limits** - Лимиты времени/стоимости запросов

## Тестирование

### Структура тестов
```
tests/
├── test_e2e.py          # End-to-end тесты
├── evaluation_obs.py    # Наблюдения для оценки
└── __init__.py
```

### Запуск тестов
```bash
# Все тесты
pytest

# С покрытием
pytest --cov=app

# Конкретный тест
pytest tests/test_e2e.py::test_response_criteria_evaluation
```


## Развитие проекта

### Планируемые улучшения
- [ ] Поддержка больше типов графиков
- [ ] Кэширование результатов запросов
- [ ] Межсессионная память
- [ ] Веб-интерфейс
- [ ] Дополнительные модели прогнозирования (ARIMA, TBATS)


## Лицензия

Этот проект создан для хакатона и предназначен для демонстрации возможностей.


**Примечание**: Проект использует модель llama4scout через RunPod endpoint в соответствии с требованиями хакатона.
